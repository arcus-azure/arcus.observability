parameters:
  azureServiceConnection: ''

steps:
  - task: AzureCLI@2
    displayName: 'Import secrets from Azure Key Vault'
    inputs:
      azureSubscription: '${{ parameters.azureServiceConnection }}'
      addSpnToEnvironment: true
      scriptType: 'pscore'
      scriptLocation: 'inlineScript'
      inlineScript: |
        Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
        Install-Module -Name Arcus.Scripting.DevOps -AllowClobber

        Set-AzDevOpsVariable -Name 'Arcus.Observability.TenantId' -Value $env:tenantId
        Set-AzDevOpsVariable -Name 'Arcus.Observability.ServicePrincipal.ClientId' -Value $env:servicePrincipalId
        Set-AzDevOpsVariable -Name 'Arcus.Observability.ServicePrincipal.ClientSecret' -Value $env:servicePrincipalKey

        $keyVaultName = ${{ variables['Arcus.KeyVault.Name'] }}

        $instrumentationKey_secretName = ${{ variables['Arcus.ApplicationInsights.InstrumentationKey.SecretName'] }}
        $instrumentationKeySecret = az keyvault secret show --name "$instrumentationKey_secretName" --vault-name "$keyVaultName" | ConvertFrom-Json
        Set-AzDevOpsVariable -AsSecret -Name 'Arcus.Observability.ApplicationInsights.InstrumentationKey' -Value $instrumentationKeySecret.value

        $resourceId_secretName = ${{ variables['Arcus.LogAnalyticsWorkspace.ResourceId.SecretName'] }}
        $resourceIdSecret = az keyvault secret show --name "$resourceId_secretName" --vault-name "$keyVaultName" | ConvertFrom-Json
        Set-AzDevOpsVariable -AsSecret -Name 'Arcus.Observability.LogAnalyticsWorkspace.ResourceId' -Value $resourceIdSecret.value