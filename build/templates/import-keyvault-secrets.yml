parameters:
  azureServiceConnection: ''

steps:
  - task: AzureCLI@2
    displayName: 'Import secrets from Azure Key Vault'
    inputs:
      azureSubscription: '${{ parameters.azureServiceConnection }}'
      scriptType: 'pscore'
      scriptLocation: 'inlineScript'
      inlineScript: |
        Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
        Install-Module -Name Arcus.Scripting.DevOps -AllowClobber

        Set-AzDevOpsVariable -Name 'Arcus.Observability.TenantId' -Value $env:tenantId
        Set-AzDevOpsVariable -Name 'Arcus.Observability.ServicePrincipal.ClientId' -Value $env:servicePrincipalId
        Set-AzDevOpsVariable -Name 'Arcus.Observability.ServicePrincipal.ClientSecret' -Value $env:servicePrincipalKey

        $keyVaultName = ${{ variables['Arcus.KeyVault.Name'] }}
        $resourceId_secretName = ${{ variables['Arcus.LogAnalyticsWorkspace.ResourceId.SecretName'] }}
        $instrumentationKey_secretName = ${{ variables['Arcus.ApplicationInsights.InstrumentationKey.SecretName'] }}
        az keyvault secret show --name $instrumentationKey_secretName --vault-name $keyVaultName --query value -o tsv | Set-AzDevOpsVariable -AsSecret -Name 'Arcus.Observability.ApplicationInsights.InstrumentationKey' -Value
        az keyvault secret show --name $resourceId_secretName --vault-name $keyVaultName --query value -o tsv | Set-AzDevOpsVariable -AsSecret -Name 'Arcus.Observability.LogAnalyticsWorkspace.ResourceId' -Value