parameters:
  azureServiceConnection: ''

steps:
  - task: AzureCLI@2
    displayName: 'Import secrets from Azure Key Vault'
    inputs:
      azureSubscription: '${{ parameters.azureServiceConnection }}'
      scriptType: 'pscore'
      scriptLocation: 'inlineScript'
      inlineScript: |
        Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
        Install-Module -Name Arcus.Scripting.DevOps -AllowClobber

        $secretNames = @(
          'ApplicationInsights.InstrumentationKey.SecretName',
          'ApplicationInsights.ApiKey.SecretName',
          'ApplicationInsights.ApplicationId.SecretName')

        $secretNames | ForEach-Object {
          $secretName = $_
          $secret = az keyvault secret show --name ${{ variables[$secretName] }} --vault-name ${{ variables['KeyVault.Name'] }} | ConvertFrom-Json
          
          $variableName = $secretName -replace '\.SecretName$', ''
          Set-AzDevOpsVariable $variableName -Value $secret.value -AsSecret }