parameters:
  azureServiceConnection: ''

steps:
  - task: AzureCLI@2
    displayName: 'Import secrets from Azure Key Vault'
    inputs:
      azureSubscription: '${{ parameters.azureServiceConnection }}'
      scriptType: 'pscore'
      scriptLocation: 'inlineScript'
      inlineScript: |
        Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
        Install-Module -Name Arcus.Scripting.DevOps -AllowClobber

        $instrumentationKeySecretName = ${{ variables['ApplicationInsights.InstrumentationKey.SecretName'] }}
        $apiKeySecretName = ${{ variables['ApplicationInsights.ApiKey.SecretName'] }}
        $applicationIdSecretName = ${{ variables['ApplicationInsights.ApplicationId.SecretName'] }}
        $secretNames = @( $instrumentationKeySecretName, $apiKeySecretName, $applicationIdSecretName )

        $secretNames | ForEach-Object {
          $secretName = $_
          $variableName = $secretName -replace '-','.'
          Write-Host "Importing Azure Key vault secret '$secretName' as Azure DevOps pipeline variable '$variableName'"
          
          $secret = az keyvault secret show --name $secretName --vault-name ${{ variables['KeyVault.Name'] }} | ConvertFrom-Json
          Set-AzDevOpsVariable $variableName -Value $secret.value -AsSecret }