parameters:
  azureServiceConnection: ''

steps:
  - task: AzureCLI@2
    displayName: 'Import secrets from Azure Key Vault'
    env:
      APPINSIGHTS_INSTRUMENTATIONKEY_SECRETNAME: $(ApplicationInsights.InstrumentationKeySecretName)
      APPINSIGHTS_APIKEY_SECRETNAME: $(ApplicationInsights.ApiKeySecretName)
      KEYVAULT_NAME: $(KeyVault.Name)
    inputs:
      azureSubscription: '${{ parameters.azureServiceConnection }}'
      scriptType: 'pscore'
      scriptLocation: 'inlineScript'
      inlineScript: |
        Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
        Install-Module -Name Arcus.Scripting.DevOps -AllowClobber

        $apiKeySecret = az keyvault secret show --name $env:APPINSIGHTS_APIKEY_SECRETNAME --vault-name $env:KEYVAULT_NAME | ConvertFrom-Json
        $instrumentationKeySecret = az keyvault secret show --name $env:APPINSIGHTS_INSTRUMENTATIONKEY_SECRETNAME --vault-name $env:KEYVAULT_NAME | ConvertFrom-Json

        Set-AzDevOpsVariable 'ApplicationInsights_InstrumentationKey' -Value $instrumentationKeySecret.value -AsSecret
        Set-AzDevOpsVariable 'ApplicationInsights_ApiKey' -Value $apiKeySecret.value -AsSecret