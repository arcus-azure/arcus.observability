parameters:
  azureServiceConnection: ''

steps:
  - task: AzureCLI@2
    displayName: 'Import secrets from Azure Key Vault'
    env:
      KeyVault_Name: ${{ variables['KeyVault.Name'] }}
      ApplicationInsights_InstrumentationKey_SecretName: ${{ variables['ApplicationInsights.InstrumentationKey.SecretName'] }}
      ApplicationInsights_ApiKey_SecretName: ${{ variables['ApplicationInsights.ApiKey.SecretName'] }}
      ApplicationInsights_ApplicationId_SecretName: ${{ variables['ApplicationInsights.ApplicationId.SecretName'] }}
    inputs:
      azureSubscription: '${{ parameters.azureServiceConnection }}'
      scriptType: 'pscore'
      scriptLocation: 'inlineScript'
      inlineScript: |
        Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
        Install-Module -Name Arcus.Scripting.DevOps -AllowClobber

        $secretNames = @(
          $env:ApplicationInsights_InstrumentationKey_SecretName,
          $env:ApplicationInsights_ApiKey_SecretName,
          $env:ApplicationInsights_ApplicationId_SecretName)

        $secretNames | ForEach-Object {
          $secretName = $_
          $variableName = $secretName -replace '-','.'
          Write-Host "Importing Azure Key vault secret '$secretName' as Azure DevOps pipeline variable '$variableName'"
          
          $secret = az keyvault secret show --name $secretName --vault-name $env:KeyVault_Name | ConvertFrom-Json
          Set-AzDevOpsVariable $variableName -Value $secret.value -AsSecret }